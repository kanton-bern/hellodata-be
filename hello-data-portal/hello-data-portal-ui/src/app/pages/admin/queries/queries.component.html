<div class="card" *ngIf="(paramContextKey$ | async) as contextKey">
  <div *ngIf="(queries$ | async) as queries">
    <p-table #dt
             [lazy]="true"
             (onLazyLoad)="loadQueries($event, contextKey)"
             [loading]="(queriesLoading$ | async) ?? false"
             [value]="queries"
             [paginator]="true"
             [rowHover]="true"
             [rowsPerPageOptions]="[5, 10, 20]"
             [rows]="10"
             [totalRecords]="queriesTotalRecords"
             [expandedRowKeys]="expandedRows"
             [globalFilterFields]="['status','tabName','databaseName', 'schema', 'table', 'userFullname', 'sql']"
             dataKey="id"
             id="queries_table_{{ contextKey }}"
             stateKey="portal-queries-table-{{ contextKey }}"
             stateStorage="session"
             styleClass="p-datatable-striped"
             [tableStyle]="{ 'min-width': '50rem' }">

      <ng-template pTemplate="caption">
        <div>
          <h3>{{ '@Queries' | transloco }}</h3>
          <div id="searchBox">
            <span class="p-input-icon-left p-ml-auto">
              <i class="pi pi-search"></i>
              <input #textInput (input)="dt.filterGlobal(filterValue, 'contains')" [(ngModel)]="filterValue" pInputText
                     placeholder="{{'@Search' | transloco}}" type="text"/>
            </span>
          </div>
        </div>
        <br><br><br>
      </ng-template>

      <ng-template pTemplate="header">
        <tr>
          <th id="statusHeader" pSortableColumn="status" style="max-width:5rem">
            <p-sortIcon field="status"></p-sortIcon>
          </th>
          <th id="changedOnHeader" pSortableColumn="changedOn" style="max-width:5rem">
            Time
            <p-sortIcon field="changedOn"></p-sortIcon>
          </th>
          <th>Duration</th>
          <th id="tabNameHeader" pSortableColumn="tabName" style="max-width:5rem">
            Tab name
            <p-sortIcon field="tabName"></p-sortIcon>
          </th>
          <th id="databaseNameHeader" pSortableColumn="databaseName" style="max-width:5rem">
            Database
            <p-sortIcon field="databaseName"></p-sortIcon>
          </th>
          <th id="schemaHeader" pSortableColumn="schema" style="max-width:5rem">
            Schema
            <p-sortIcon field="schema"></p-sortIcon>
          </th>
          <th id="sqlTablesHeader" pSortableColumn="sqlTables" style="max-width:5rem">
            Tables
            <p-sortIcon field="sqlTables"></p-sortIcon>
          </th>
          <th id="userFullnameHeader" pSortableColumn="userFullname" style="max-width:5rem">
            User
            <p-sortIcon field="userFullname"></p-sortIcon>
          </th>
          <th></th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-query let-expanded="expanded">
        <tr [ngSwitch]="query.status">
          <td>
            <span *ngSwitchCase="'failed'" [pTooltip]="query.status" class="align-items-end pi pi-exclamation-circle"
                  style="color: red"></span>
            <span *ngSwitchCase="'success'" [pTooltip]="query.status" class="align-items-end pi pi-check-circle"
                  style="color: green"></span>
          </td>
          <td>{{ formatChangedOn(query.changedOn) }}</td>
          <td>
            <p-tag *ngSwitchCase="'failed'" severity="danger"
                   [value]="formatDuration(query.endTime - query.startTime)"></p-tag>
            <p-tag *ngSwitchCase="'success'" severity="success"
                   [value]="formatDuration(query.endTime - query.startTime)"></p-tag>
          </td>
          <td>{{ query.tabName }}</td>
          <td>{{ query.databaseName }}</td>
          <td>{{ query.schema }}</td>
          <td>
            <ng-container *ngFor="let table of JSON.parse(query.sqlTables); let last = last">
              {{ table.table }}<span *ngIf="!last">, </span>
            </ng-container>
          </td>
          <td>{{ query.userFullname }}</td>
          <td>
            <p-button type="button" pRipple [pRowToggler]="query" [text]="true" [rounded]="true"
                      [plain]="true" pTooltip="SQL"
                      [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"/>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="rowexpansion" let-query>
        <tr>
          <td colspan="9">
            <div class="p-3">
            <textarea
              variant="filled"
              [disabled]="true"
              cols="30"
              rows="5"
              pInputTextarea
              variant="filled"
              [autoResize]="true"
              style="width: 100%"
              [(ngModel)]="query.sql">
            </textarea>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>
</div>
