<div class="card">
  @if ((editedDashboardGroup$ | async); as editedDashboardGroup) {
    <form [formGroup]="dashboardGroupForm">
      <h5>{{ '@Dashboard group' | transloco }} - {{ currentDomainName }}</h5>
      @if (editedDashboardGroup.createdDate) {
        <div class="field grid grid-cols-12 gap-4 mb-1">
          <label class="col-span-12 mb-2 md:col-span-2 md:mb-0"
                 for="createdDate">{{ '@Created date' | transloco }}</label>
          <div class="col-span-12 md:col-span-10">
            <input
              class="opacity-40 text-base text-color bg-surface-0 p-2 border border-solid border-surface rounded-border appearance-none outline-0 focus:border-primary w-full"
              disabled
              id="createdDate"
              type="text"
              value="{{editedDashboardGroup.createdDate | date: 'dd.MM.yyyy HH:mm:ss'}}">
          </div>
        </div>
      }
      @if (editedDashboardGroup.createdBy) {
        <div class="field grid grid-cols-12 gap-4 mb-1">
          <label class="col-span-12 mb-2 md:col-span-2 md:mb-0" for="createdBy">{{ '@Created by' | transloco }}</label>
          <div class="col-span-12 md:col-span-10">
            <input
              class="opacity-40 text-base text-color bg-surface-0 p-2 border border-solid border-surface rounded-border appearance-none outline-0 focus:border-primary w-full"
              disabled
              id="createdBy"
              type="text"
              value="{{editedDashboardGroup.createdBy}}">
          </div>
        </div>
      }
      @if (editedDashboardGroup.modifiedDate) {
        <div class="field grid grid-cols-12 gap-4 mb-1">
          <label class="col-span-12 mb-2 md:col-span-2 md:mb-0"
                 for="modifiedDate">{{ '@Modified date' | transloco }}</label>
          <div class="col-span-12 md:col-span-10">
            <input
              class="opacity-40 text-base text-color bg-surface-0 p-2 border border-solid border-surface rounded-border appearance-none outline-0 focus:border-primary w-full"
              disabled
              id="modifiedDate"
              type="text"
              value="{{editedDashboardGroup.modifiedDate | date: 'dd.MM.yyyy HH:mm:ss'}}">
          </div>
        </div>
      }
      @if (editedDashboardGroup.modifiedBy) {
        <div class="field grid grid-cols-12 gap-4 mb-1">
          <label class="col-span-12 mb-2 md:col-span-2 md:mb-0"
                 for="modifiedBy">{{ '@Modified by' | transloco }}</label>
          <div class="col-span-12 md:col-span-10">
            <input
              class="opacity-40 text-base text-color bg-surface-0 p-2 border border-solid border-surface rounded-border appearance-none outline-0 focus:border-primary w-full"
              disabled
              id="modifiedBy"
              type="text"
              value="{{editedDashboardGroup.modifiedBy}}">
          </div>
        </div>
      }
      <div class="field grid grid-cols-12 gap-4 mb-2">
        <label class="col-span-12 mb-2 md:col-span-2 md:mb-0" for="name">{{ '@Group name' | transloco }}</label>
        <div class="col-span-12 md:col-span-10">
          <input
            class="text-base text-color bg-surface-0 p-2 border border-solid border-surface rounded-border appearance-none outline-0 focus:border-primary w-full"
            formControlName="name"
            id="name"
            pInputText
            type="text">
          @if (dashboardGroupForm.controls['name'].hasError('duplicateName') && dashboardGroupForm.controls['name'].dirty) {
            <small class="p-error">{{ '@Dashboard group name already exists' | transloco }}</small>
          }
          @if (!dashboardGroupForm.controls['name'].valid && !dashboardGroupForm.controls['name'].hasError('duplicateName') && dashboardGroupForm.controls['name'].dirty) {
            <small class="p-error">{{ '@Group name is invalid' | transloco }}</small>
          }
        </div>
      </div>

      <p-divider/>

      <p-tabs value="0">
        <p-tablist>
          <p-tab value="0">
            <i class="fas fa-chart-pie mr-2"></i>
            {{ '@Dashboards' | transloco }} ({{ selectedDashboardIds.size }})
          </p-tab>
          <p-tab value="1">
            <i class="fas fa-users mr-2"></i>
            {{ '@Users' | transloco }} ({{ selectedUserIds.size }})
          </p-tab>
        </p-tablist>
        <p-tabpanels>
          <!-- Dashboards Tab -->
          <p-tabpanel value="0">
            <div class="mb-3 flex items-center justify-between">
              <div class="flex items-center gap-2">
                <p-checkbox [(ngModel)]="selectAllDashboards" [ngModelOptions]="{standalone: true}"
                            (ngModelChange)="onSelectAllDashboardsChange($event, editedDashboardGroup)"
                            [binary]="true" inputId="selectAllDashboards"/>
                <label for="selectAllDashboards">{{ '@Select all' | transloco }}</label>
              </div>
              <p-iconfield>
                <p-inputicon class="pi pi-search"/>
                <input pInputText [(ngModel)]="dashboardSearchFilter" [ngModelOptions]="{standalone: true}"
                       (ngModelChange)="onDashboardSearchChange()"
                       placeholder="{{ '@Search dashboards' | transloco }}" type="text"/>
              </p-iconfield>
            </div>
            <div class="dashboard-list max-h-96 overflow-y-auto border border-surface rounded-border p-2">
              @if (filteredDashboards.length === 0) {
                <div class="text-gray-400 p-4 text-center text-sm">{{ '@No dashboards available' | transloco }}</div>
              } @else {
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-1">
                  @for (dashboard of filteredDashboards; track dashboard.id) {
                    <div class="flex items-start gap-2 p-1 hover:bg-surface-100 rounded-border">
                      <p-checkbox class="mt-0.5" [ngModel]="isDashboardSelected(dashboard.id)"
                                  [ngModelOptions]="{standalone: true}"
                                  (ngModelChange)="onDashboardSelectionChange(dashboard.id, $event, editedDashboardGroup)"
                                  [binary]="true" [inputId]="'dashboard-' + dashboard.id"/>
                      <label [for]="'dashboard-' + dashboard.id" class="cursor-pointer flex-1 text-sm dashboard-label">
                        {{ dashboard.dashboardTitle }}
                      </label>
                    </div>
                  }
                </div>
              }
            </div>
          </p-tabpanel>

          <!-- Users Tab -->
          <p-tabpanel value="1">
            <div class="mb-3 flex items-center justify-between">
              <div class="flex items-center gap-2">
                <p-checkbox [(ngModel)]="selectAllUsers" [ngModelOptions]="{standalone: true}"
                            (ngModelChange)="onSelectAllUsersChange($event, editedDashboardGroup)"
                            [binary]="true" inputId="selectAllUsers"/>
                <label for="selectAllUsers">{{ '@Select all' | transloco }}</label>
              </div>
              <p-iconfield>
                <p-inputicon class="pi pi-search"/>
                <input pInputText [(ngModel)]="userSearchFilter" [ngModelOptions]="{standalone: true}"
                       (ngModelChange)="onUserSearchChange()"
                       placeholder="{{ '@Search users' | transloco }}" type="text"/>
              </p-iconfield>
            </div>
            <div class="user-list max-h-96 overflow-y-auto border border-surface rounded-border p-2">
              @if (filteredUsers.length === 0) {
                <div class="text-gray-400 p-4 text-center text-sm">{{ '@No users available' | transloco }}</div>
              } @else {
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-1">
                  @for (user of filteredUsers; track user.id) {
                    <div class="flex items-start gap-2 p-1 hover:bg-surface-100 rounded-border">
                      <p-checkbox class="mt-0.5" [ngModel]="isUserSelected(user.id)"
                                  [ngModelOptions]="{standalone: true}"
                                  (ngModelChange)="onUserSelectionChange(user.id, $event, editedDashboardGroup)"
                                  [binary]="true" [inputId]="'user-' + user.id"/>
                      <label [for]="'user-' + user.id" class="cursor-pointer flex-1 text-xs leading-tight">
                        <span class="font-medium block truncate">{{ user.firstName }} {{ user.lastName }}</span>
                        <span class="text-gray-500 block truncate">{{ user.email }}</span>
                        <span
                          class="inline-block mt-0.5 px-1.5 py-0.5 text-[10px] bg-blue-100 text-blue-700 rounded">{{ formatRoleName(user.roleName) }}</span>
                      </label>
                    </div>
                  }
                </div>
              }
            </div>
          </p-tabpanel>
        </p-tabpanels>
      </p-tabs>

      <p-toolbar class="mt-4">
        <div class="p-toolbar-group-start">
          <p-button (click)="navigateToList()" [pTooltip]="'@Cancel' | transloco" class="mr-2"
                    icon="fas fa-arrow-left" severity="secondary" pRipple
                    (keydown.enter)="navigateToList()"/>
        </div>
        <div class="p-toolbar-group-end">
          <p-button (click)="saveDashboardGroup(editedDashboardGroup)"
                    (keydown.enter)="saveDashboardGroup(editedDashboardGroup)"
                    [disabled]="!dashboardGroupForm.valid"
                    icon="fas fa-floppy-disk" class="mr-2"
                    [label]="'@Save' | transloco"
                    severity="success" pRipple/>
          @if (editedDashboardGroup.id) {
            <p-button (click)="openDeletePopup(editedDashboardGroup)"
                      (keydown.enter)="openDeletePopup(editedDashboardGroup)"
                      icon="fas fa-trash" class="mr-2"
                      [label]="'@Delete' | transloco"
                      severity="danger" pRipple/>
          }
        </div>
      </p-toolbar>
    </form>
  }
</div>
<br>
<app-delete-dashboard-group-popup [action]="getDeletionAction()"/>
