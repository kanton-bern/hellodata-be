<div class="comment-item border rounded-md px-2 py-2"
     [class.bg-white]="activeVersion()?.status === CommentStatus.PUBLISHED"
     [class.bg-gray-100]="activeVersion()?.status === CommentStatus.DRAFT"
     [class.draft-border]="activeVersion()?.status === CommentStatus.DRAFT">
  @if (comment().pointerUrl) {
    <div class="pointer-url-container px-1 pb-1">
      <a class="pointer-url-link text-xs text-blue-600 hover:underline cursor-pointer"
         (click)="navigateToPointerUrl()"
         (keydown.enter)="navigateToPointerUrl()">
        <i class="fa-solid fa-thumbtack mr-1"></i>{{ '@Go to referenced page' | transloco }}
      </a>
    </div>
  }
  <p class="comment-text p-1">{{ activeVersion()?.text }}</p>
  <div class="comment-footer p-1">
    <div class="comment-meta-row">
      <small class="comment-meta">
        <span class="author-name"
              [pTooltip]="comment().authorEmail"
              tooltipPosition="top">{{ comment().author }}</span>
        â€“ {{ comment().createdDate | date:'short' }}
        @if (activeVersion()?.editedDate && activeVersion()?.editedDate !== comment().createdDate) {
          <span class="edited-badge">({{ '@edited' | transloco }})</span>
        }
        @if (comment().activeVersion > 1) {
          <span class="version-badge">v{{ comment().activeVersion }}</span>
        }
      </small>
      <div class="comment-actions">
        @if (canViewMetadata()) {
          <button class="info-btn"
                  (click)="toggleDetails()"
                  (keydown)="onKeyDown($event, toggleDetails.bind(this))">
            <i class="fa fa-info-circle"></i>
          </button>
        }
        @if (canEdit()) {
          <button class="edit-btn"
                  (click)="editComment()"
                  (keydown)="onKeyDown($event, editComment.bind(this))"
                  [pTooltip]="'@Edit' | transloco"
                  tooltipPosition="top">
            <i class="fa-solid fa-pen"></i>
          </button>
        }
        @if (canPublish()) {
          <button class="publish-btn"
                  (click)="publishComment()"
                  (keydown)="onKeyDown($event, publishComment.bind(this))"
                  [pTooltip]="'@Publish' | transloco"
                  tooltipPosition="top">
            <i class="fa-solid fa-cloud-arrow-up"></i>
          </button>
        }
        @if (canUnpublish()) {
          <button class="unpublish-btn"
                  (click)="unpublishComment()"
                  (keydown)="onKeyDown($event, unpublishComment.bind(this))"
                  [pTooltip]="'@Unpublish' | transloco"
                  tooltipPosition="top">
            <i class="fa-solid fa-cloud-arrow-down"></i>
          </button>
        }
        @if (canDelete()) {
          <button class="delete-btn"
                  (click)="deleteComment()"
                  (keydown)="onKeyDown($event, deleteComment.bind(this))"
                  [pTooltip]="'@Delete' | transloco"
                  tooltipPosition="top">
            <i class="fa fa-trash"></i>
          </button>
        }
      </div>
    </div>
  </div>
  @if (expanded) {
    <div class="comment-details p-1">
      <small>
        <div><strong>{{ '@Status' | transloco }}:</strong> {{ '@' + activeVersion()?.status | transloco }}</div>
        <div><strong>{{ '@Version' | transloco }}:</strong> {{ comment().activeVersion }}</div>
        <div><strong>{{ '@Created date' | transloco }}:</strong> {{ comment().createdDate | date:'medium' }}</div>
        @if (activeVersion()?.publishedDate) {
          <div><strong>{{ '@Published' | transloco }}:</strong> {{ activeVersion()?.publishedDate | date:'medium' }}
            @if (activeVersion()?.publishedBy) {
              ({{ activeVersion()?.publishedBy }})
            }
          </div>
        }
        @if (activeVersion()?.editedDate && activeVersion()?.editedDate !== comment().createdDate) {
          <div><strong>{{ '@Last edited' | transloco }}:</strong> {{ activeVersion()?.editedDate | date:'medium' }}
            @if (activeVersion()?.editedBy) {
              ({{ activeVersion()?.editedBy }})
            }
          </div>
        }
        @if (allVersions().length > 1) {
          <div class="version-history mt-2">
            <strong>{{ '@Version history' | transloco }}:</strong>
            <ul class="history-list">
              @for (historyItem of allVersions(); track historyItem.version) {
                <li class="history-item" [class.active-version]="historyItem.isCurrentVersion">
                  <span class="history-version">v{{ historyItem.version }}</span>
                  @if (historyItem.isCurrentVersion) {
                    <span class="active-badge">{{ '@Active' | transloco }}</span>
                  }
                  <span class="status-badge" [class.status-draft]="historyItem.status === CommentStatus.DRAFT"
                        [class.status-published]="historyItem.status === CommentStatus.PUBLISHED">
                    {{ '@' + historyItem.status | transloco }}
                  </span>
                  <span class="history-date">{{ historyItem.editedDate | date:'short' }}</span>
                  <span class="history-author">{{ historyItem.editedBy }}</span>
                  <span class="history-text" [pTooltip]="historyItem.text" tooltipPosition="top">
                    {{ historyItem.text | slice:0:30 }}{{ historyItem.text.length > 30 ? '...' : '' }}
                  </span>
                  @if (!historyItem.isCurrentVersion && historyItem.status === CommentStatus.PUBLISHED && canViewMetadata()) {
                    <button class="restore-btn"
                            (click)="restoreVersion(historyItem.version)"
                            (keydown)="onKeyDown($event, restoreVersion.bind(this, historyItem.version))"
                            [pTooltip]="'@Restore this version' | transloco"
                            tooltipPosition="left">
                      <i class="fa-solid fa-rotate-left"></i>
                    </button>
                  }
                </li>
              }
            </ul>
          </div>
        }
      </small>
    </div>
  }
</div>

<!-- Edit Comment Dialog -->
<p-dialog [header]="'@Edit comment' | transloco"
          [(visible)]="editDialogVisible"
          [modal]="true"
          [style]="{width: '90%', maxWidth: '500px'}"
          [draggable]="false"
          [resizable]="false">
  <div class="edit-dialog-content">
    @if (activeVersion()?.status === CommentStatus.PUBLISHED) {
      <div class="edit-warning mb-3">
        <i class="fa-solid fa-triangle-exclamation text-orange-500 mr-2"></i>
        <span>{{ '@Edit published comment warning' | transloco }}</span>
      </div>
    }
    <textarea pInputTextarea
              [(ngModel)]="editedText"
              [rows]="5"
              [autoResize]="true"
              class="w-full"
              placeholder="{{ '@Write a comment' | transloco }}"></textarea>
    <div class="mt-3">
      <input type="text"
             class="w-full border rounded-md px-2 py-1 text-sm"
             [class.border-red-500]="editedPointerUrl && !isEditedPointerUrlValid()"
             [class.border-2]="editedPointerUrl && !isEditedPointerUrlValid()"
             [(ngModel)]="editedPointerUrl"
             placeholder="{{ '@Link to specific page (optional)' | transloco }}"/>
      @if (editedPointerUrl && !isEditedPointerUrlValid()) {
        <div class="text-red-500 mt-1"
             style="font-size: 0.65rem; line-height: 1;">{{ '@Pointer URL must be a Superset link' | transloco }}
        </div>
      }
    </div>
  </div>
  <ng-template pTemplate="footer">
    <p-button (click)="cancelEdit()" (keydown.escape)="cancelEdit()"
              icon="fas fa-circle-xmark"
              [label]="'@Cancel' | transloco"
              severity="secondary"/>
    <p-button (click)="saveEdit()" (keydown.enter)="saveEdit()"
              icon="fas fa-save"
              [label]="'@Save' | transloco"
              severity="success"
              [disabled]="isSaveEditDisabled()"/>
  </ng-template>
</p-dialog>

