<div class="comments-container">

  <div class="comments-header">
    <h4 class="text-center">{{ '@Comments' | transloco }}</h4>
  </div>

  <div class="comments-filters flex gap-2 px-2 py-1">
    <div class="filter-group">
      <span class="filter-label">{{ '@Year' | transloco }}</span>
      <p-select [options]="yearOptions"
                [(ngModel)]="selectedYear"
                (onChange)="onFilterChange()"
                optionLabel="label"
                optionValue="value"
                placeholder="{{ '@All' | transloco }}"
                [style]="{'width': '100%'}"
                size="small"/>
    </div>
    <div class="filter-group">
      <span class="filter-label">{{ '@Quarter' | transloco }}</span>
      <p-select [options]="quarterOptions"
                [(ngModel)]="selectedQuarter"
                (onChange)="onFilterChange()"
                optionLabel="label"
                optionValue="value"
                placeholder="{{ '@All' | transloco }}"
                [style]="{'width': '100%'}"
                size="small"/>
    </div>
  </div>

  <div class="comment-scrollpanel" #scrollContainer>
    @if ((filteredComments$ | async); as comments) {
      @if (comments.length) {
        <div class="comments-list">
          @for (comment of comments; track comment.id) {
            <app-comment-entry [comment]="comment"
                               (pointerUrlClick)="onPointerUrlClick($event)"></app-comment-entry>
          }
        </div>
      } @else {
        <div class="h-full flex items-center justify-center text-gray-400">
          {{ '@No comments' | transloco }}
        </div>
      }
    } @else {
      <div class="h-full flex items-center justify-center text-gray-400">
        {{ '@No comments' | transloco }}
      </div>
    }
  </div>

  <div class="comment-form">
      <textarea
        class="w-full border rounded-md"
        [(ngModel)]="newCommentText"
        placeholder="{{ '@Write a comment' | transloco }}"
        rows="3">
      </textarea>

    <div class="mt-2 flex gap-2 items-start">
      <div class="flex-1">
        <input type="text"
               class="w-full border rounded-md px-2 py-1 text-sm"
               [class.border-red-500]="pointerUrl && !isPointerUrlValid()"
               [class.border-2]="pointerUrl && !isPointerUrlValid()"
               [(ngModel)]="pointerUrl"
               placeholder="{{ '@Link to specific page (optional)' | transloco }}"/>
        @if (pointerUrl && !isPointerUrlValid()) {
          <div class="text-red-500 mt-1"
               style="font-size: 0.65rem; line-height: 1;">{{ '@Pointer URL must be a Superset link' | transloco }}
          </div>
        }
      </div>
      <p-button severity="success" (keydown.enter)="submitComment()"
                label="{{ '@Submit' | transloco }}"
                (click)="submitComment()"
                [disabled]="!newCommentText?.trim() || (pointerUrl && !isPointerUrlValid())">
      </p-button>
    </div>
  </div>

</div>

<p-confirmDialog #cd1 key="publishComment" [style]="{width: '50vw'}">
  <ng-template pTemplate="footer">
    <p-button (click)="cd1.onReject()" icon="fas fa-circle-xmark" label="{{'@Cancel' | transloco}}"
              severity="secondary" (keydown.escape)="cd1.onReject()"/>
    <p-button (click)="cd1.onAccept()" icon="fas fa-cloud-arrow-up"
              label="{{'@Publish' | transloco}}" (keydown.enter)="cd1.onReject()"
              severity="success"/>
  </ng-template>
</p-confirmDialog>

<p-confirmDialog #cd2 key="unpublishComment" [style]="{width: '50vw'}">
  <ng-template pTemplate="footer">
    <p-button (click)="cd2.onReject()" icon="fas fa-circle-xmark" label="{{'@Cancel' | transloco}}"
              severity="secondary" (keydown.escape)="cd2.onReject()"/>
    <p-button (click)="cd2.onAccept()" icon="fas fa-cloud-arrow-down"
              label="{{'@Unpublish' | transloco}}" (keydown.enter)="cd2.onAccept()"
              severity="warn"/>
  </ng-template>
</p-confirmDialog>

<p-confirmDialog #cd3 key="deleteComment" [style]="{width: '50vw'}">
  <ng-template pTemplate="footer">
    <p-button (click)="cd3.onReject()" icon="fas fa-circle-xmark" label="{{'@Cancel' | transloco}}"
              severity="secondary" (keydown.escape)="cd3.onReject()"/>
    <p-button (click)="cd3.onAccept()" icon="fas fa-trash"
              label="{{'@Delete' | transloco}}" (keydown.enter)="cd3.onAccept()"
              severity="danger"/>
  </ng-template>
</p-confirmDialog>

<p-confirmDialog #cd4 key="restoreVersion" [style]="{width: '50vw'}">
  <ng-template pTemplate="footer">
    <p-button (click)="cd4.onReject()" icon="fas fa-circle-xmark" label="{{'@Cancel' | transloco}}"
              severity="secondary" (keydown.escape)="cd4.onReject()"/>
    <p-button (click)="cd4.onAccept()" icon="fas fa-rotate-left"
              label="{{'@Restore' | transloco}}" (keydown.enter)="cd4.onAccept()"
              severity="success"/>
  </ng-template>
</p-confirmDialog>

