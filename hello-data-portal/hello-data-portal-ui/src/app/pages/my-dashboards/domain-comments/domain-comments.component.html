<h2 class="content-block">{{ '@Domain Comments' | transloco }}: {{ contextName }}</h2>
<div class="card">
  <p-table
    #dt
    [value]="comments"
    [loading]="loading"
    [paginator]="true"
    [rows]="10"
    [rowsPerPageOptions]="[10, 25, 50]"
    [globalFilterFields]="['text', 'author', 'dashboardTitle', 'tagsString', 'statusLabel']"
    [tableStyle]="{'min-width': '60rem'}"
    styleClass="p-datatable-striped">

    <ng-template pTemplate="caption">
      <div class="table-header flex justify-between items-center gap-4">
        <p-button
          [label]="'@Clear' | transloco"
          severity="secondary"
          icon="pi pi-filter-slash"
          (click)="clearFilter(dt)" (keydown.enter)="clearFilter(dt)"/>
        <p-iconfield>
          <p-inputicon styleClass="pi pi-search"/>
          <input
            pInputText
            type="text"
            [(ngModel)]="globalFilterValue"
            (input)="onGlobalFilter(dt, $event)"
            [placeholder]="'@Search' | transloco"/>
        </p-iconfield>
      </div>
    </ng-template>

    <ng-template pTemplate="header">
      <tr>
        <th scope="col" pSortableColumn="dashboardTitle" style="width: 14%">
          {{ '@Dashboard' | transloco }}
          <p-sortIcon field="dashboardTitle"/>
        </th>
        <th scope="col" pSortableColumn="text" style="width: 32%">
          {{ '@Comment' | transloco }}
          <p-sortIcon field="text"/>
        </th>
        <th scope="col" pSortableColumn="author" style="width: 10%">
          {{ '@Author' | transloco }}
          <p-sortIcon field="author"/>
        </th>
        <th scope="col" style="width: 12%">
          {{ '@Tags' | transloco }}
        </th>
        <th scope="col" pSortableColumn="status" style="width: 8%">
          {{ '@Status' | transloco }}
          <p-sortIcon field="status"/>
        </th>
        <th scope="col" pSortableColumn="createdDate" style="width: 10%">
          {{ '@Created' | transloco }}
          <p-sortIcon field="createdDate"/>
        </th>
        <th scope="col" style="width: 14%">
          {{ '@Actions' | transloco }}
        </th>
      </tr>
    </ng-template>

    <ng-template pTemplate="body" let-comment>
      <tr>
        <td>
          {{ comment.dashboardTitle || ('Dashboard ' + comment.dashboardId) }}
        </td>
        <td class="comment-text">
          <span [pTooltip]="getActiveVersionData(comment)?.text || ''" tooltipPosition="top">
            {{ (getActiveVersionData(comment)?.text || '') | slice:0:80 }}
            @if ((getActiveVersionData(comment)?.text || '').length > 80) {
              ...
            }
          </span>
        </td>
        <td>
          <span [pTooltip]="comment.authorEmail" tooltipPosition="top">
            {{ comment.author }}
          </span>
        </td>
        <td>
          @if (comment.tags && comment.tags.length > 0) {
            <div class="flex gap-1 flex-wrap">
              @for (tag of comment.tags; track tag) {
                <span class="tag-chip">
                  <i class="fa-solid fa-tag text-xs mr-1"></i>{{ tag }}
                </span>
              }
            </div>
          }
        </td>
        <td>
          <p-tag
            [value]="getStatusLabel(getActiveVersionData(comment)?.status || 'DRAFT') | transloco"
            [severity]="getStatusSeverity(getActiveVersionData(comment)?.status || 'DRAFT')"/>
        </td>
        <td>
          {{ comment.createdDate | date:'dd.MM.yy, HH:mm' }}
        </td>
        <td>
          <div class="action-buttons">
            <!-- Open dashboard button -->
            <p-button
              icon="fa-up-right-from-square fas"
              [rounded]="true"
              class="mr-2"
              [text]="true"
              severity="info"
              [pTooltip]="'@Open Dashboard' | transloco"
              tooltipPosition="top"
              (click)="navigateToDashboard(comment)" (keydown.enter)="navigateToDashboard(comment)"/>
            <!-- Info button -->
            @if (canViewMetadata()) {
              <p-button
                icon="fa fa-info-circle"
                [rounded]="true"
                [text]="true"
                severity="help"
                class="mr-2"
                [styleClass]="isExpanded(comment) ? 'info-btn-active' : ''"
                [pTooltip]="'@Info' | transloco"
                tooltipPosition="top"
                (click)="toggleDetails(comment)" (keydown.enter)="toggleDetails(comment)"/>
            }
            <!-- Edit button -->
            @if (canEdit(comment)) {
              <p-button
                icon="fa-solid fa-pen"
                [rounded]="true"
                [text]="true"
                severity="success"
                class="mr-2"
                [pTooltip]="'@Edit' | transloco"
                tooltipPosition="top"
                (click)="editComment(comment)" (keydown.enter)="editComment(comment)"/>
            }
            <!-- Publish button -->
            @if (canPublish(comment)) {
              <p-button
                icon="fa-solid fa-cloud-arrow-up"
                [rounded]="true"
                [text]="true"
                severity="warn"
                class="mr-2"
                [pTooltip]="'@Publish' | transloco"
                tooltipPosition="top"
                (click)="publishCommentAction(comment)" (keydown.enter)="publishCommentAction(comment)"/>
            }
            <!-- Send for review button -->
            @if (canSendForReview(comment)) {
              <p-button
                icon="fa-solid fa-paper-plane"
                [rounded]="true"
                [text]="true"
                severity="info"
                class="mr-2"
                [pTooltip]="'@Send for review' | transloco"
                tooltipPosition="top"
                (click)="sendForReviewAction(comment)" (keydown.enter)="sendForReviewAction(comment)"/>
            }
            <!-- Decline button -->
            @if (canDecline(comment)) {
              <p-button
                icon="fa-solid fa-circle-stop"
                [rounded]="true"
                [text]="true"
                severity="danger"
                class="mr-2"
                [pTooltip]="'@Decline' | transloco"
                tooltipPosition="top"
                (click)="openDeclineDialog(comment)" (keydown.enter)="openDeclineDialog(comment)"/>
            }
            <!-- Delete button -->
            @if (canDelete(comment)) {
              <p-button
                icon="fa fa-trash"
                [rounded]="true"
                [text]="true"
                severity="danger"
                [pTooltip]="'@Delete' | transloco"
                tooltipPosition="top"
                (click)="deleteCommentAction(comment)" (keydown.enter)="deleteCommentAction(comment)"/>
            }
          </div>
        </td>
      </tr>
      <!-- Expanded details row -->
      @if (isExpanded(comment)) {
        <tr class="expanded-row">
          <td colspan="7">
            <div class="comment-details p-3 bg-gray-50 rounded-md">
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <strong>{{ '@Status' | transloco }}:</strong>
                  {{ '@' + getActiveVersionData(comment)?.status | transloco }}
                </div>
                <div>
                  <strong>{{ '@Version' | transloco }}:</strong>
                  {{ comment.activeVersion }}
                </div>
                <div>
                  <strong>{{ '@Created date' | transloco }}:</strong>
                  {{ comment.createdDate | date:'medium' }}
                </div>
                @if (getActiveVersionData(comment)?.publishedDate) {
                  <div>
                    <strong>{{ '@Published' | transloco }}:</strong>
                    {{ getActiveVersionData(comment)?.publishedDate | date:'medium' }}
                    @if (getActiveVersionData(comment)?.publishedBy) {
                      ({{ getActiveVersionData(comment)?.publishedBy }})
                    }
                  </div>
                }
                @if (getActiveVersionData(comment)?.status === DashboardCommentStatus.DECLINED && getActiveVersionData(comment)?.declineReason) {
                  <div class="col-span-2">
                    <div class="bg-red-50 border-l-4 border-red-500 p-3 rounded">
                      <strong class="text-red-700">{{ '@Decline reason' | transloco }}:</strong>
                      <p class="text-red-600 mt-1">{{ getActiveVersionData(comment)?.declineReason }}</p>
                      @if (getActiveVersionData(comment)?.publishedBy) {
                        <p class="text-red-500 text-sm mt-1">
                          {{ '@Declined by' | transloco }}: {{ getActiveVersionData(comment)?.publishedBy }}
                          @if (getActiveVersionData(comment)?.publishedDate) {
                            - {{ getActiveVersionData(comment)?.publishedDate | date:'short' }}
                          }
                        </p>
                      }
                    </div>
                  </div>
                }
                @if (getActiveVersionData(comment)?.editedDate && getActiveVersionData(comment)?.editedDate !== comment.createdDate) {
                  <div>
                    <strong>{{ '@Last edited' | transloco }}:</strong>
                    {{ getActiveVersionData(comment)?.editedDate | date:'medium' }}
                    @if (getActiveVersionData(comment)?.editedBy) {
                      ({{ getActiveVersionData(comment)?.editedBy }})
                    }
                  </div>
                }
                @if (comment.pointerUrl) {
                  <div>
                    <strong>{{ '@Pointer URL' | transloco }}:</strong>
                    <a [href]="comment.pointerUrl" target="_blank" class="text-blue-600 hover:underline">
                      {{ comment.pointerUrl | slice:0:50 }}...
                    </a>
                  </div>
                }
              </div>
              <!-- Version history -->
              @if (getAllVersions(comment).length > 1) {
                <div class="version-history mt-4">
                  <strong>{{ '@Version history' | transloco }}:</strong>
                  <table class="history-table w-full mt-2 text-sm">
                    <thead>
                    <tr class="bg-gray-100">
                      <th scope="col" class="p-2 text-left">{{ '@Version' | transloco }}</th>
                      <th scope="col" class="p-2 text-left">{{ '@Status' | transloco }}</th>
                      <th scope="col" class="p-2 text-left">{{ '@Date' | transloco }}</th>
                      <th scope="col" class="p-2 text-left">{{ '@Author' | transloco }}</th>
                      <th scope="col" class="p-2 text-left">{{ '@Text' | transloco }}</th>
                      <th scope="col" class="p-2 text-left">{{ '@Link' | transloco }}</th>
                      <th scope="col" class="p-2 text-left">{{ '@Tags' | transloco }}</th>
                      <th scope="col" class="p-2 text-left">{{ '@Actions' | transloco }}</th>
                    </tr>
                    </thead>
                    <tbody>
                      @for (historyItem of getAllVersions(comment); track historyItem.version) {
                        <tr [class.bg-blue-50]="historyItem.isCurrentVersion">
                          <td class="p-2">
                            v{{ historyItem.version }}
                            @if (historyItem.isCurrentVersion) {
                              <span
                                class="ml-1 text-xs bg-blue-500 text-white px-1 rounded">{{ '@Active' | transloco }}</span>
                            }
                          </td>
                          <td class="p-2">
                            <p-tag
                              [value]="getStatusLabel(historyItem.status) | transloco"
                              [severity]="getStatusSeverity(historyItem.status)"
                              [style]="{fontSize: '0.7rem'}"/>
                          </td>
                          <td class="p-2">{{ historyItem.editedDate | date:'short' }}</td>
                          <td class="p-2">{{ historyItem.editedBy }}</td>
                          <td class="p-2">
                          <span [pTooltip]="historyItem.text" tooltipPosition="top">
                            {{ historyItem.text | slice:0:30 }}{{ historyItem.text.length > 30 ? '...' : '' }}
                          </span>
                          </td>
                          <td class="p-2">
                            @if (historyItem.pointerUrl) {
                              <button type="button"
                                      class="text-blue-600 hover:underline cursor-pointer bg-transparent border-none p-0 text-left"
                                      [pTooltip]="historyItem.pointerUrl"
                                      tooltipPosition="top"
                                      (click)="navigateToDashboard(comment, historyItem.pointerUrl)">
                                <i class="fa-solid fa-thumbtack mr-1" style="font-size: 0.6rem;"></i>
                                {{ historyItem.pointerUrl | slice:0:20 }}{{ historyItem.pointerUrl.length > 20 ? '...' : '' }}
                              </button>
                            } @else {
                              <span class="text-gray-400">-</span>
                            }
                          </td>
                          <td class="p-2">
                            @if (historyItem.tags && historyItem.tags.length > 0) {
                              <div class="flex gap-1 flex-wrap">
                                @for (tag of historyItem.tags; track tag) {
                                  <span class="text-xs bg-blue-100 text-blue-700 px-1 rounded">
                                    <i class="fa-solid fa-tag mr-1" style="font-size: 0.6rem;"></i>{{ tag }}
                                  </span>
                                }
                              </div>
                            } @else {
                              <span class="text-gray-400">-</span>
                            }
                          </td>
                          <td class="p-2">
                            @if (!historyItem.isCurrentVersion && historyItem.status === DashboardCommentStatus.PUBLISHED && canViewMetadata()) {
                              <p-button
                                icon="fa-solid fa-rotate-left"
                                [rounded]="true"
                                [text]="true"
                                severity="help"
                                [pTooltip]="'@Restore this version' | transloco"
                                tooltipPosition="left"
                                (click)="restoreVersion(comment, historyItem.version)"
                                (keydown.enter)="restoreVersion(comment, historyItem.version)"/>
                            }
                          </td>
                        </tr>
                        @if (historyItem.status === DashboardCommentStatus.DECLINED && historyItem.declineReason) {
                          <tr [class.bg-blue-50]="historyItem.isCurrentVersion">
                            <td colspan="8" class="p-2">
                              <div class="bg-red-50 border-l-4 border-red-500 p-2 rounded">
                                <strong class="text-red-700 text-xs">{{ '@Decline reason' | transloco }}:</strong>
                                <p class="text-red-600 text-xs mt-1">{{ historyItem.declineReason }}</p>
                              </div>
                            </td>
                          </tr>
                        }
                      }
                    </tbody>
                  </table>
                </div>
              }
            </div>
          </td>
        </tr>
      }
    </ng-template>

    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="6" class="text-center p-4">
          {{ '@No comments found' | transloco }}
        </td>
      </tr>
    </ng-template>
  </p-table>
</div>

<!-- Edit Comment Dialog -->
<p-dialog [header]="'@Edit comment' | transloco"
          [(visible)]="editDialogVisible"
          [modal]="true"
          [style]="{width: '90%', maxWidth: '500px'}"
          [draggable]="false"
          [resizable]="false">
  <div class="edit-dialog-content">
    @if (editingComment && getActiveVersionData(editingComment)?.status === DashboardCommentStatus.PUBLISHED) {
      <div class="edit-warning mb-3">
        <i class="fa-solid fa-triangle-exclamation text-orange-500 mr-2"></i>
        <span>{{ '@Edit published comment warning' | transloco }}</span>
      </div>
    }
    @if (editingComment && getActiveVersionData(editingComment)?.status === DashboardCommentStatus.DECLINED) {
      <div class="edit-warning mb-3">
        <i class="fa-solid fa-triangle-exclamation text-orange-500 mr-2"></i>
        <span>{{ '@Edit declined comment warning' | transloco }}</span>
      </div>
    }
    <textarea pInputTextarea
              [(ngModel)]="editedText"
              [rows]="5"
              [autoResize]="true"
              class="w-full"
              placeholder="{{ '@Write a comment' | transloco }}"></textarea>
    <div class="mt-3">
      <div class="flex gap-1 items-center">
        <input type="text"
               class="flex-1 border rounded-md px-2 py-1 text-sm"
               [class.border-red-500]="editedPointerUrl && !isEditedPointerUrlValid()"
               [class.border-2]="editedPointerUrl && !isEditedPointerUrlValid()"
               [(ngModel)]="editedPointerUrl"
               placeholder="{{ '@Link to specific page (optional)' | transloco }}"/>
        @if (editedPointerUrl) {
          <button type="button"
                  class="clear-pointer-url-btn"
                  (click)="clearEditedPointerUrl()"
                  (keydown.enter)="clearEditedPointerUrl()"
                  [pTooltip]="'@Clear' | transloco"
                  tooltipPosition="top">
            <i class="fa-solid fa-xmark"></i>
          </button>
        }
      </div>
      @if (editedPointerUrl && !isEditedPointerUrlValid()) {
        <div class="text-red-500 mt-1"
             style="font-size: 0.65rem; line-height: 1;">{{ '@Pointer URL must be a Superset link' | transloco }}
        </div>
      }
    </div>

    <!-- Tags section -->
    <div class="mt-3">
      <label for="editTagInput" class="block text-sm font-medium text-gray-700 mb-1">{{ '@Tags' | transloco }}</label>
      <div class="flex gap-1 flex-wrap mb-2">
        @for (tag of editedTags; track tag) {
          <span class="tag-item">
            <i class="fa-solid fa-tag"></i>
            <span>{{ tag }}</span>
            <button type="button" class="tag-remove"
                    (click)="removeEditTag(tag)"
                    (keydown.enter)="removeEditTag(tag)"
                    (keydown.space)="removeEditTag(tag)">
              <i class="fa-solid fa-xmark"></i>
            </button>
          </span>
        }
        @if (editedTags.length === 0) {
          <span class="text-gray-400 text-sm">{{ '@No tags selected' | transloco }}</span>
        }
      </div>
      <div class="flex gap-2 w-full">
        <p-autoComplete [(ngModel)]="editNewTagText"
                        [suggestions]="editTagSuggestions"
                        (completeMethod)="searchEditTags($event)"
                        (onSelect)="onEditTagSelect($event)"
                        (onKeyUp)="$event.key === 'Enter' && addEditTag()"
                        [maxlength]="10"
                        placeholder="{{ '@Add tag (max 10 chars)' | transloco }}"
                        styleClass="tags-autocomplete w-full"
                        inputStyleClass="w-full"
                        appendTo="body"
                        inputId="editTagInput"
                        class="flex-1"/>
        <p-button icon="fas fa-plus"
                  (click)="addEditTag()"
                  (keydown.enter)="addEditTag()"
                  [disabled]="!editNewTagText?.trim()"
                  severity="secondary"/>
      </div>
    </div>
  </div>
  <ng-template pTemplate="footer">
    <p-button (click)="cancelEdit()" (keydown.escape)="cancelEdit()"
              icon="fas fa-circle-xmark"
              [label]="'@Cancel' | transloco"
              severity="secondary"/>
    <p-button (click)="saveEdit()" (keydown.enter)="saveEdit()"
              icon="fas fa-save"
              [label]="'@Save' | transloco"
              severity="success"
              [disabled]="isSaveEditDisabled()"/>
  </ng-template>
</p-dialog>

<!-- Decline Comment Dialog -->
<p-dialog [header]="'@Decline draft' | transloco"
          [(visible)]="declineDialogVisible"
          [modal]="true"
          [style]="{width: '90%', maxWidth: '500px'}"
          [draggable]="false"
          [resizable]="false">
  <div class="decline-dialog-content">
    <div class="decline-warning mb-3 flex items-center p-3 bg-orange-50 border border-orange-200 rounded">
      <i class="fa-solid fa-triangle-exclamation text-orange-500 mr-2"></i>
      <span class="text-orange-700 text-sm">{{ '@Decline comment warning' | transloco }}</span>
    </div>
    <label for="declineReasonInput" class="block text-sm font-medium text-gray-700 mb-2">
      {{ '@Decline reason' | transloco }} *
    </label>
    <textarea pInputTextarea
              id="declineReasonInput"
              [(ngModel)]="declineReason"
              [rows]="4"
              [autoResize]="true"
              class="w-full"
              placeholder="{{ '@Enter reason for declining this draft' | transloco }}"></textarea>
  </div>
  <ng-template pTemplate="footer">
    <p-button (click)="closeDeclineDialog()" (keydown.escape)="closeDeclineDialog()"
              icon="fas fa-circle-xmark"
              [label]="'@Cancel' | transloco"
              severity="secondary"/>
    <p-button (click)="submitDecline()" (keydown.enter)="submitDecline()"
              icon="fas fa-ban"
              [label]="'@Decline' | transloco"
              severity="danger"
              [disabled]="isDeclineDisabled()"/>
  </ng-template>
</p-dialog>

<!-- Confirm Dialog - Publish -->
<p-confirmDialog #cd1 key="publishComment" [style]="{width: '50vw'}">
  <ng-template pTemplate="footer">
    <p-button (click)="cd1.onReject()" icon="fas fa-circle-xmark" label="{{'@Cancel' | transloco}}"
              severity="secondary" (keydown.escape)="cd1.onReject()"/>
    <p-button (click)="cd1.onAccept()" icon="fas fa-cloud-arrow-up"
              label="{{'@Publish' | transloco}}" (keydown.enter)="cd1.onAccept()"
              severity="success"/>
  </ng-template>
</p-confirmDialog>

<p-confirmDialog #cd5 key="sendForReview" [style]="{width: '50vw'}">
  <ng-template pTemplate="footer">
    <p-button (click)="cd5.onReject()" icon="fas fa-circle-xmark" label="{{'@Cancel' | transloco}}"
              severity="secondary" (keydown.escape)="cd5.onReject()"/>
    <p-button (click)="cd5.onAccept()" icon="fas fa-paper-plane"
              label="{{'@Send for review' | transloco}}" (keydown.enter)="cd5.onAccept()"
              severity="info"/>
  </ng-template>
</p-confirmDialog>

<!-- Confirm Dialog - Unpublish -->
<p-confirmDialog #cd2 key="unpublishComment" [style]="{width: '50vw'}">
  <ng-template pTemplate="footer">
    <p-button (click)="cd2.onReject()" icon="fas fa-circle-xmark" label="{{'@Cancel' | transloco}}"
              severity="secondary" (keydown.escape)="cd2.onReject()"/>
    <p-button (click)="cd2.onAccept()" icon="fas fa-cloud-arrow-down"
              label="{{'@Unpublish' | transloco}}" (keydown.enter)="cd2.onAccept()"
              severity="warn"/>
  </ng-template>
</p-confirmDialog>

<!-- Confirm Dialog - Delete -->
<p-confirmDialog #cd3 key="deleteComment" [style]="{width: '50vw'}">
  <ng-template pTemplate="message">
    <div class="flex flex-col gap-3">
      <span>{{ '@Delete comment question' | transloco }}</span>
      <div class="flex items-center gap-2">
        <input type="checkbox" id="deleteEntireCheckboxDomain"
               [checked]="commentUtils.deleteEntireFlag"
               (change)="commentUtils.deleteEntireFlag = $any($event.target).checked"/>
        <label for="deleteEntireCheckboxDomain">{{ '@Delete entire comment' | transloco }}</label>
      </div>
    </div>
  </ng-template>
  <ng-template pTemplate="footer">
    <p-button (click)="cd3.onReject()" icon="fas fa-circle-xmark" label="{{'@Cancel' | transloco}}"
              severity="secondary" (keydown.escape)="cd3.onReject()"/>
    <p-button (click)="cd3.onAccept()" icon="fas fa-trash"
              label="{{'@Delete' | transloco}}" (keydown.enter)="cd3.onAccept()"
              severity="danger"/>
  </ng-template>
</p-confirmDialog>

<!-- Confirm Dialog - Restore Version -->
<p-confirmDialog #cd4 key="restoreVersion" [style]="{width: '50vw'}">
  <ng-template pTemplate="footer">
    <p-button (click)="cd4.onReject()" icon="fas fa-circle-xmark" label="{{'@Cancel' | transloco}}"
              severity="secondary" (keydown.escape)="cd4.onReject()"/>
    <p-button (click)="cd4.onAccept()" icon="fas fa-rotate-left"
              label="{{'@Restore' | transloco}}" (keydown.enter)="cd4.onAccept()"
              severity="success"/>
  </ng-template>
</p-confirmDialog>
