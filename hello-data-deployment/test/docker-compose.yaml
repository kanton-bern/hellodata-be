version: '3.8'

services:
  keycloak:
    image: bedag/hello-data-dc-keycloak
    ports:
      - 38080:8080
    environment:
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
      KEYCLOAK_IMPORT: /opt/keycloak/data/import/realm.json
      DB_VENDOR: h2
      KC_HEALTH_ENABLED: "true"
      JAVA_OPTS_APPEND: "-Dcom:redhat:fips=false"
      KC_SPI_CONFIG_UPDATE_MODE: "IGNORE"
      KC_SPI_CONFIG_UPDATE_ENABLE: "false"
    healthcheck:
      test: [ "CMD", "curl", "http://localhost:8080/realms/hellodata" ]
      interval: 10s
      timeout: 5s
      retries: 50
    restart: always
    extra_hosts:
      - "host.docker.internal:host-gateway"
      - "keycloak.localhost:host-gateway"
    entrypoint: [ "/opt/keycloak/bin/kc.sh", "start-dev", "--import-realm", "--hostname", "localhost", "--http-enabled", "true" ]

  zookeeper:
    hostname: zookeeper
    image: 'bitnami/zookeeper:latest'
    environment:
      - ALLOW_ANONYMOUS_LOGIN=yes

  nifi:
    image: apache/nifi:2.2.0
    container_name: nifi
    restart: always
    environment:
      NIFI_WEB_HTTP_HOST: '0.0.0.0'
      NIFI_SECURITY_USER_OIDC_DISCOVERY_URL: "http://host.docker.internal:38080/realms/hellodata/.well-known/openid-configuration"
      NIFI_SECURITY_USER_OIDC_CLIENT_ID: "frontend-client"
      NIFI_SECURITY_USER_OIDC_CLIENT_SECRET: "not-needed"
      NIFI_SECURITY_USER_OIDC_CLAIM_IDENTIFYING_USER: "email"
      NIFI_SECURITY_USER_OIDC_AUTHORIZATION_ENDPOINT: "http://host.docker.internal:38080/realms/hellodata/protocol/openid-connect/auth"
      NIFI_SECURITY_USER_OIDC_TOKEN_ENDPOINT: "http://host.docker.internal:38080/realms/hellodata/protocol/openid-connect/token"
      NIFI_SECURITY_USER_OIDC_USERINFO_ENDPOINT: "http://host.docker.internal:38080/realms/hellodata/protocol/openid-connect/userinfo"
      NIFI_SECURITY_USER_OIDC_LOGOUT_ENDPOINT: "http://host.docker.internal:38080/realms/hellodata/protocol/openid-connect/logout"
      NIFI_SECURITY_USER_AUTHORIZER: "managed-authorizer"
      NIFI_SECURITY_USER_LOGIN_IDENTITY_PROVIDER: ""
    depends_on:
      - keycloak
      - zookeeper
    ports:
      - target: 8443
        published: 8443
        protocol: tcp
        mode: host
    volumes:
      - ./authorizers.xml:/opt/nifi/nifi-current/conf/authorizers.xml
      #      - ./nifi.properties:/opt/nifi/nifi-current/conf/nifi.properties
      - nifi_data:/opt/nifi/nifi-current/conf
    extra_hosts:
      - "host.docker.internal:host-gateway"
      - "keycloak.localhost:host-gateway"

volumes:
  keycloak_data:
  nifi_data:
